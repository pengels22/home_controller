<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Home Controller - Quick GUI</title>
  <link rel="stylesheet" href="/static/home_controller.css" />
  <style>
    /* small overrides for the GUI panel */
    .gui-grid { display:flex; gap:14px; align-items:flex-start; }
    .gui-left { flex: 0 0 360px; }
    .gui-right { flex: 1 1 auto; }
    pre.readout { background:#0b0d12; border:1px solid rgba(255,255,255,0.04); padding:12px; color:var(--muted); white-space:pre-wrap; }
  </style>
</head>
<body>
  <header class="topbar">
    <div class="brand">
      <div class="brand-title">Home Controller</div>
      <div class="brand-sub">Quick Module GUI</div>
    </div>
    <div class="topbar-right">
      <a class="btn-link" href="/">Back</a>
      <a class="btn-link" href="/ui/add">+ Add Module</a>
      <a class="btn-link" href="/ui/gui">GUI Panel</a>
    </div>
  </header>

  <main class="container">
    <section class="card">
      <div class="gui-grid">
        <div class="gui-left">
          <div style="margin-bottom:10px">
            <label style="display:block;margin-bottom:6px;font-weight:800">Module</label>
            <select id="moduleSelect" style="width:100%"></select>
          </div>

          <div id="moduleInfo" style="margin-bottom:12px;color:var(--muted)"></div>

          <div style="margin-bottom:10px">
            <button id="refreshBtn">Refresh</button>
            <button id="readBtn" style="margin-left:8px">Read Module</button>
          </div>

          <div id="writePane">
            <div style="display:flex;gap:8px;align-items:center;margin-bottom:10px">
              <label style="min-width:70px">Channel</label>
              <select id="channelSelect" style="flex:1"></select>
            </div>
            <div style="display:flex;gap:8px;align-items:center;margin-bottom:6px">
              <label style="min-width:70px">Value</label>
              <input id="valueInput" style="flex:1" />
            </div>
            <div>
              <button id="writeBtn">Write</button>
            </div>
          </div>
        </div>

        <div class="gui-right">
          <h3>Module Output</h3>
          <pre id="readOut" class="readout">(no data)</pre>

          <div id="aioChannels" style="margin-top:12px;display:none">
            <h4>Analog Inputs</h4>
            <div class="channels-grid" id="aioChannelsGrid"></div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <script>
    async function fetchModules(){
      const r = await fetch('/api/gui/modules');
      const mods = await r.json();
      const sel = document.getElementById('moduleSelect');
      sel.innerHTML = '';
      mods.forEach(m => {
        const opt = document.createElement('option');
        opt.value = m.id;
        opt.text = `Slot ${m.slot}: ${m.type.toUpperCase()} ${m.name ? '- ' + m.name : ''} (${m.address})`;
        sel.appendChild(opt);
      });
      if(mods.length) sel.selectedIndex = 0;
      await updateModuleInfo();
    }

    async function updateModuleInfo(){
      const sel = document.getElementById('moduleSelect');
      const id = sel.value; if(!id) return;
      const r = await fetch('/api/gui/modules');
      const mods = await r.json();
      const m = mods.find(x=>x.id===id);
      const info = document.getElementById('moduleInfo');
      info.textContent = `Type: ${m.type.toUpperCase()} | Address: ${m.address} | Present: ${m.present}`;

      // populate channel selector
      const chSel = document.getElementById('channelSelect');
      chSel.innerHTML = '';
      const total = (m.channels_out || m.channels_in || 0) || (m.type==='aio'?8:0);
      for(let i=1;i<=total;i++){
        const o = document.createElement('option'); o.value = i; o.text = i; chSel.appendChild(o);
      }

      const val = document.getElementById('valueInput');
      if(m.type==='do') val.value = '1';
      else if(m.type==='aio') val.value = '12.0';
      else val.value = '';

      // If AIO, auto-read and show channels
      if(m.type==='aio'){
        await readModule(true);
      } else {
        document.getElementById('aioChannels').style.display = 'none';
      }
    }

    async function readModule(suppressOut=false){
      const id = document.getElementById('moduleSelect').value;
      const r = await fetch(`/api/gui/action`, {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({module_id:id, action:'read'})});
      const j = await r.json();
      document.getElementById('readOut').textContent = JSON.stringify(j, null, 2);

      // If AIO response contains channels, populate grid
      if(j && j.ok && j.type === 'aio' && j.channels){
        const grid = document.getElementById('aioChannelsGrid');
        grid.innerHTML = '';
        for(let i=1;i<=8;i++){
          const row = document.createElement('div'); row.className = 'channel-row';
          const label = document.createElement('div'); label.className = 'channel-label'; label.textContent = 'CH ' + i;
          const input = document.createElement('input'); input.className = 'channel-input'; input.value = (j.channels[String(i)] !== undefined ? j.channels[String(i)] : '');
          input.readOnly = true;
          row.appendChild(label); row.appendChild(input);
          grid.appendChild(row);
        }
        document.getElementById('aioChannels').style.display = '';
      } else {
        document.getElementById('aioChannels').style.display = 'none';
      }
    }

    async function writeModule(){
      const id = document.getElementById('moduleSelect').value;
      const ch = parseInt(document.getElementById('channelSelect').value,10);
      const val = document.getElementById('valueInput').value;
      const payload = { module_id: id, action: 'write', channel: ch, value: (isNaN(Number(val))? val : Number(val)) };
      const r = await fetch(`/api/gui/action`, {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)});
      const j = await r.json();
      document.getElementById('readOut').textContent = JSON.stringify(j, null, 2);
      // refresh modules and info
      await fetchModules();
    }

    document.getElementById('refreshBtn').addEventListener('click', fetchModules);
    document.getElementById('moduleSelect').addEventListener('change', updateModuleInfo);
    document.getElementById('readBtn').addEventListener('click', ()=>readModule(false));
    document.getElementById('writeBtn').addEventListener('click', writeModule);

    fetchModules();
  </script>
</body>
</html>
