<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Home Controller - Quick GUI</title>
  <style>
    body { font-family: sans-serif; margin: 20px; }
    .row { margin-bottom: 12px; }
    label { display: inline-block; width: 120px; }
    select, input { min-width: 200px; }
    pre { background:#f6f6f6;padding:8px;border:1px solid #ddd }
  </style>
</head>
<body>
  <h2>Quick Module GUI</h2>
  <div class="row">
    <label>Module</label>
    <select id="moduleSelect"></select>
    <button id="refreshBtn">Refresh</button>
  </div>

  <div id="moduleInfo" class="row"></div>

  <div id="readPane" class="row">
    <button id="readBtn">Read Module</button>
    <pre id="readOut">(no data)</pre>
  </div>

  <div id="writePane" class="row">
    <label>Channel</label>
    <select id="channelSelect"></select>
    <label style="margin-left:12px">Value</label>
    <input id="valueInput" />
    <button id="writeBtn">Write</button>
  </div>

  <script>
    async function fetchModules(){
      const r = await fetch('/api/gui/modules');
      const mods = await r.json();
      const sel = document.getElementById('moduleSelect');
      sel.innerHTML = '';
      mods.forEach(m => {
        const opt = document.createElement('option');
        opt.value = m.id;
        opt.text = `Slot ${m.slot}: ${m.type.toUpperCase()} ${m.name || ''} (${m.address})`;
        sel.appendChild(opt);
      });
      if(mods.length) sel.selectedIndex = 0;
      updateModuleInfo();
    }

    async function updateModuleInfo(){
      const sel = document.getElementById('moduleSelect');
      const id = sel.value; if(!id) return;
      const r = await fetch('/api/gui/modules');
      const mods = await r.json();
      const m = mods.find(x=>x.id===id);
      const info = document.getElementById('moduleInfo');
      info.textContent = `Type: ${m.type} | Address: ${m.address} | Present: ${m.present}`;

      // populate channels
      const chSel = document.getElementById('channelSelect');
      chSel.innerHTML = '';
      const total = (m.channels_out || m.channels_in || 0);
      for(let i=1;i<=total;i++){
        const o = document.createElement('option'); o.value = i; o.text = i; chSel.appendChild(o);
      }

      const val = document.getElementById('valueInput');
      if(m.type==='do') val.value = '1';
      else if(m.type==='aio') val.value = '12.0';
      else val.value = '';
    }

    async function readModule(){
      const id = document.getElementById('moduleSelect').value;
      const r = await fetch(`/api/gui/action`, {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({module_id:id, action:'read'})});
      const j = await r.json();
      document.getElementById('readOut').textContent = JSON.stringify(j, null, 2);
    }

    async function writeModule(){
      const id = document.getElementById('moduleSelect').value;
      const ch = parseInt(document.getElementById('channelSelect').value,10);
      const val = document.getElementById('valueInput').value;
      // try to coerce numeric
      const payload = { module_id: id, action: 'write', channel: ch, value: (isNaN(Number(val))? val : Number(val)) };
      const r = await fetch(`/api/gui/action`, {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)});
      const j = await r.json();
      document.getElementById('readOut').textContent = JSON.stringify(j, null, 2);
      // refresh info
      await fetchModules();
    }

    document.getElementById('refreshBtn').addEventListener('click', fetchModules);
    document.getElementById('moduleSelect').addEventListener('change', updateModuleInfo);
    document.getElementById('readBtn').addEventListener('click', readModule);
    document.getElementById('writeBtn').addEventListener('click', writeModule);

    fetchModules();
  </script>
</body>
</html>
