<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Add Module • Home Controller</title>
  <link rel="stylesheet" href="/static/home_controller.css?v=20260219a" />
</head>
<body>
  <header class="topbar">
    <div class="brand">
      <div class="brand-title">Home Controller</div>
      <div class="brand-sub">Add Module</div>
    </div>

    <div class="topbar-right">
      <a class="btn-link" href="/ui">← Back to Modules</a>
    </div>
  </header>

  <main class="container">
    <section class="card">
      <h2>Add Module</h2>


      <div class="form-row">
        <label for="add_type">Module Type</label>
        <select id="add_type">
          <option value="di">DI</option>
          <option value="do">DO</option>
          <option value="aio">AIO</option>
          <option value="i2c">I2C Module</option>
          <option value="rs485">RS485</option>
          <option value="genmon">GenMon</option>
        </select>
      </div>

      <div class="form-row" id="address_row">
        <label id="address_display" style="font-size:16px;font-weight:600;margin-bottom:8px;">RS485 Address: <span id="address_value">1</span></label>
      </div>
      <div class="form-row" id="dip_switch_row" style="margin-top:0;">
        <div id="dip_switch_ui" style="margin-top:0;display:flex;flex-direction:row;gap:24px;justify-content:flex-start;">
          <div class="dipswitch-group">
            <div class="dipswitch-label">SW1</div>
            <div class="dipswitch">
              <div class="dipswitch-slider dipswitch-off" id="dip1_slider" onclick="toggleDip(1)"></div>
              <div class="dipswitch-state" id="dip1_val">OFF</div>
                <input type="number" id="dip1" value="0" min="0" max="1" style="display:none;" />
            </div>
          </div>
          <div class="dipswitch-group">
            <div class="dipswitch-label">SW2</div>
            <div class="dipswitch">
              <div class="dipswitch-slider dipswitch-off" id="dip2_slider" onclick="toggleDip(2)"></div>
              <div class="dipswitch-state" id="dip2_val">OFF</div>
                <input type="number" id="dip2" value="0" min="0" max="1" style="display:none;" />
            </div>
          </div>
          <div class="dipswitch-group">
            <div class="dipswitch-label">SW3</div>
            <div class="dipswitch">
              <div class="dipswitch-slider dipswitch-off" id="dip3_slider" onclick="toggleDip(3)"></div>
              <div class="dipswitch-state" id="dip3_val">OFF</div>
                <input type="number" id="dip3" value="0" min="0" max="1" style="display:none;" />
            </div>
          </div>
        </div>
        <div style="margin-top:6px;font-size:12px;color:#666;">Set DIP switches to set the RS485 address for your module</div>
      </div>

      <div class="form-row">
        <label for="add_name">Name (optional)</label>
        <input id="add_name" placeholder="Doors, Lights, etc." />
      </div>

      <div class="form-actions">
        <button onclick="addModuleThenGoBack()">Add Module</button>
      </div>

      <div id="add_error" class="error-box" style="display:none;"></div>
    </section>
  </main>

  <script src="/static/home_controller.js?v=20260219a"></script>
  <script>
    // DIP switches always shown, set RS485 address
    const dipSwitchRow = document.getElementById('dip_switch_row');
    const addressValue = document.getElementById('address_value');
    function updateRs485Address() {
      // Example: address = DIP1 + DIP2*2 + DIP3*4 (binary)
      const dip1 = document.getElementById('dip1').value;
      const dip2 = document.getElementById('dip2').value;
      const dip3 = document.getElementById('dip3').value;
      const addr = parseInt(dip1) + parseInt(dip2)*2 + parseInt(dip3)*4 + 1; // +1 for 1-based
      addressValue.textContent = addr;
    }
    document.getElementById('dip1').addEventListener('change', updateRs485Address);
    document.getElementById('dip2').addEventListener('change', updateRs485Address);
    document.getElementById('dip3').addEventListener('change', updateRs485Address);
    // Also update when toggling via slider
    window.toggleDip = function(n) {
      const input = document.getElementById('dip'+n);
      input.value = input.value === '0' ? '1' : '0';
      updateRs485Address();
      // ...existing code for slider UI...
    }
    // Initial address
    updateRs485Address();
  </script>
</body>
</html>
